name: build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Typecheck TypeScript
        run: npm run check-ts

      - name: Lint JavaScript
        run: npm run lint-js

      - name: Check NPM module usage
        run: npm run check-modules

  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run test
        run: npm run test

  # tests-coverage:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version-file: '.tool-versions'
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm install

  #     - name: Run test
  #       run: npm run test-coverage

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run build
        run: npm run build

  update-web:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get Shared Client version
        run: CLIENT_HASH=`git rev-parse --short HEAD`

      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: 'techmatters/terraso-web-client'
          ref: 'staging'
          token: ${{ secrets.TERRASO_CLIENT_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install "github:techmatters/terraso-client-shared#${CLIENT_HASH}"
          npm install

      - name: Commit version bump
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          git commit -m "build: update shared client to ${CLIENT_HASH}"
          git push
