name: build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm install

      - name: Typecheck TypeScript
        run: npm run check-ts

      - name: Lint JavaScript
        run: npm run lint-js

      - name: Check NPM module usage
        run: npm run check-modules

  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run test
        run: npm run test

  # tests-coverage:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version-file: '.tool-versions'
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm install

  #     - name: Run test
  #       run: npm run test-coverage

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get shared client version
        id: getClientHash
        run: echo "client_hash=`git rev-parse --short main`" >> "$GITHUB_ENV"

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.tool-versions'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run build
        run: npm run build
    outputs:
      client_hash: ${{ env.client_hash }}

  update-web:
    needs: build
    uses: ./.github/workflows/update-shared.yml
    with:
      repo-path: 'techmatters/terraso-web-client'
      repo-ref: 'staging'
      cache-dependency-path: 'package-lock.json'
      client-hash: ${{ needs.build.outputs.client_hash }}
    secrets:
      token: ${{ secrets.TERRASO_CLIENT_TOKEN }}

  update-mobile:
    needs: build
    uses: ./.github/workflows/update-shared.yml
    with:
      repo-path: 'techmatters/terraso-mobile-client'
      repo-ref: 'main'
      cache-dependency-path: 'dev-client/package-lock.json'
      working-directory: './dev-client'
      client-hash: ${{ needs.build.outputs.client_hash }}
    secrets:
      token: ${{ secrets.TERRASO_CLIENT_TOKEN }}
